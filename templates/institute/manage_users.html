{% extends 'institute/base.html' %}
{% load static %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                <i class="fas fa-users-cog text-indigo-600 dark:text-indigo-400"></i>
                Manage Users
            </h1>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Administer system accounts and permissions</p>
        </div>
        <a href="{% url 'register' %}"
            class="inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-xl shadow-sm transition-colors">
            <i class="fas fa-plus mr-2"></i> Create User
        </a>
    </div>

    <!-- Messages -->
    {% if messages %}
    <div class="space-y-2">
        {% for message in messages %}
        <div
            class="p-4 rounded-xl {% if message.tags == 'success' %}bg-green-50 text-green-700 border border-green-200{% elif message.tags == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-blue-50 text-blue-700 border border-blue-200{% endif %} flex justify-between items-center">
            <span class="text-sm font-medium">{{ message }}</span>
            <button onclick="this.parentElement.remove()" class="text-current opacity-50 hover:opacity-100"><i
                    class="fas fa-times"></i></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Users Table -->
    <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr
                        class="bg-slate-50 dark:bg-slate-900/50 text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider">
                        <th class="p-4 font-semibold w-16">#</th>
                        <th class="p-4 font-semibold">User Details</th>
                        <th class="p-4 font-semibold">Role</th>
                        <th class="p-4 font-semibold">Status</th>
                        <th class="p-4 font-semibold text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                    {% for user in users %}
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                        <td class="p-4 text-slate-400 font-mono text-sm">{{ forloop.counter }}</td>
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400 font-bold text-sm">
                                    {{ user.username|slice:":2"|upper }}
                                </div>
                                <div>
                                    <p class="font-semibold text-slate-900 dark:text-white">{{ user.username }}</p>
                                    <p class="text-xs text-slate-500 font-mono">{{ user.uid }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="p-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                {% if user.user_type == 'admin' %}bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300
                                {% elif user.user_type == 'student' %}bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300
                                {% else %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300{% endif %}">
                                {{ user.user_type|upper }}
                            </span>
                        </td>
                        <td class="p-4">
                            <span
                                class="flex items-center gap-1.5 text-sm font-medium {% if user.status == 'active' %}text-emerald-600 dark:text-emerald-400{% else %}text-slate-500{% endif %}">
                                <span
                                    class="w-2 h-2 rounded-full {% if user.status == 'active' %}bg-emerald-500{% else %}bg-slate-400{% endif %}"></span>
                                {{ user.status|title }}
                            </span>
                        </td>
                        <td class="p-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <button onclick="openEditModal('{{ user.id }}')"
                                    class="p-2 text-slate-400 hover:text-amber-500 transition-colors bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg shadow-sm">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="confirmDelete('{{ user.id }}', '{{ user.username }}')"
                                    class="p-2 text-slate-400 hover:text-red-500 transition-colors bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg shadow-sm">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>

                    <!-- Edit Modal (Hidden Helper) -->
                    <dialog id="editModal{{ user.id }}"
                        class="modal-helper hidden fixed inset-0 z-50 overflow-y-auto w-full h-full bg-transparent">
                        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"
                            onclick="closeEditModal('{{ user.id }}')"></div>
                        <div class="relative min-h-[calc(100vh-4rem)] flex items-center justify-center p-4">
                            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-md p-6 relative">
                                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Edit User: {{
                                    user.username }}</h3>
                                <form method="POST" action="{% url 'edit_user' user.id %}" class="space-y-4">
                                    {% csrf_token %}

                                    <div>
                                        <label
                                            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Username</label>
                                        <input type="text" name="username" value="{{ user.username }}"
                                            class="w-full px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-500">
                                    </div>

                                    <div>
                                        <label
                                            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">UID</label>
                                        <input type="text" name="uid" value="{{ user.uid }}"
                                            class="w-full px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-500">
                                    </div>

                                    <div>
                                        <label
                                            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Role</label>
                                        <select name="user_type"
                                            class="w-full px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-500">
                                            <option value="admin" {% if user.user_type=='admin' %}selected{% endif %}>
                                                Admin</option>
                                            <option value="student" {% if user.user_type=='student' %}selected{% endif
                                                %}>Student</option>
                                            <option value="staff" {% if user.user_type=='staff' %}selected{% endif %}>
                                                Staff</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label
                                            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Status</label>
                                        <select name="status"
                                            class="w-full px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-500">
                                            <option value="active" {% if user.status=='active' %}selected{% endif %}>
                                                Active</option>
                                            <option value="inactive" {% if user.status=='inactive' %}selected{% endif
                                                %}>Inactive</option>
                                        </select>
                                    </div>

                                    <div class="flex justify-end gap-3 pt-4">
                                        <button type="button" onclick="closeEditModal('{{ user.id }}')"
                                            class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">Cancel</button>
                                        <button type="submit"
                                            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-sm">Save
                                            Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </dialog>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="p-8 text-center text-slate-500">No users found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function openEditModal(userId) {
        document.getElementById('editModal' + userId).classList.remove('hidden');
    }

    function closeEditModal(userId) {
        document.getElementById('editModal' + userId).classList.add('hidden');
    }

    function confirmDelete(userId, userName) {
        if (confirm(`Are you sure you want to delete user "${userName}"?`)) {
            // Create form to submit delete
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/delete_user/${userId}/`;

            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = 'csrfmiddlewaretoken';
            csrf.value = '{{ csrf_token }}';
            form.appendChild(csrf);

            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}